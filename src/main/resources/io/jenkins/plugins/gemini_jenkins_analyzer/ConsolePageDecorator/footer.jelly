<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:l="/lib/layout">
    <j:if test="${it.pluginActive}">
        <script src="${rootURL}/plugin/gemini-jenkins-analyzer/js/analyzer-error-footer.js" type="text/javascript"/>

        <!-- Error Patterns Configuration -->
        <div id="analyzer-error-patterns-container" class="jenkins-hidden">
          <l:card title="Error Pattern Configuration">
            <p style="margin-bottom: 10px;">Enter regular expressions to filter error logs (one per line). Leave empty to analyze all logs.</p>
            <textarea id="analyzer-error-patterns" rows="10" class="jenkins-input" style="font-family: monospace; width: 100%; padding: 8px; border-radius: 4px;" placeholder="(?i)\bError\s*:\s*&#10;(?i)\bException\b&#10;(?i)^\s*\*\*\s*BUILD FAILED\s*\*\*"></textarea>
            <div class="jenkins-button-bar" style="margin-top: 10px;">
              <button type="button" class="jenkins-button jenkins-button--primary eep-start-analysis-button">
                Start Analysis
              </button>
              <button type="button" class="jenkins-button eep-cancel-patterns-button">
                Cancel
              </button>
            </div>
          </l:card>
        </div>

        <div id="analyzer-error-logs-container" class="jenkins-hidden" style="margin-bottom: 15px;">
          <details class="analyzer-details-container" style="border-radius: 6px; padding: 10px;">
            <summary style="cursor: pointer; font-weight: 600; padding: 5px; user-select: none; display: flex; justify-content: space-between; align-items: center;">
              <span>ðŸ“‹ Error Logs Being Analyzed</span>
              <button type="button" class="jenkins-button jenkins-button--tertiary analyzer-copy-btn" onclick="copyErrorLogsToClipboard(event)" title="Copy to clipboard">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
              </button>
            </summary>
            <pre id="analyzer-error-logs-content" class="analyzer-pre-content jenkins-!-margin-bottom-0" style="padding: 10px; border-radius: 4px; margin-top: 10px; max-height: 300px; overflow-y: auto;"></pre>
          </details>
        </div>

        <div id="analyzer-error-container" class="jenkins-hidden" style="margin-bottom: 15px;">
          <details id="analyzer-error-details" open="true" class="analyzer-details-container" style="border-radius: 6px; padding: 10px;">
            <summary style="cursor: pointer; font-weight: 600; padding: 5px; user-select: none; display: flex; justify-content: space-between; align-items: center;">
              <span>
                <span id="analyzer-status-icon">ðŸ¤–</span> <span id="analyzer-status-text">AI Error Analysis</span>
              </span>
              <button type="button" class="jenkins-button jenkins-button--tertiary analyzer-copy-btn" onclick="copyAnalysisToClipboard(event)" title="Copy to clipboard">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
              </button>
            </summary>
            <div style="margin-top: 10px;">
              <div id="analyzer-error-spinner" class="jenkins-hidden" style="padding: 20px; text-align: center;">
                <l:spinner text=""/>
                <div class="analyzer-spinner-text" style="margin-top: 10px; font-weight: 600;">
                  âš¡ Generating AI Analysis...
                </div>
              </div>
              <pre id="analyzer-error-content" class="analyzer-pre-content jenkins-!-margin-bottom-0" style="padding: 10px; border-radius: 4px; max-height: 500px; overflow-y: auto;"></pre>
            </div>
          </details>
        </div>

        <style>
          /* Dark mode support using CSS custom properties */
          .analyzer-details-container {
            border: 1px solid var(--input-border);
            background: var(--background);
          }

          .analyzer-pre-content {
            background-color: var(--background);
            border: 1px solid var(--input-border);
            color: var(--text-color);
          }

          .analyzer-spinner-text {
            color: var(--link-color, #0066cc);
          }

          .analyzer-copy-btn {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            font-size: 13px;
          }

          .analyzer-copy-btn:hover {
            opacity: 0.8;
          }

          .analyzer-copy-btn svg {
            flex-shrink: 0;
          }

          /* Ensure proper contrast in both modes */
          @media (prefers-color-scheme: dark) {
            .analyzer-details-container {
              border-color: #444;
              background: #2b2b2b;
            }

            .analyzer-pre-content {
              background-color: #1e1e1e;
              border-color: #444;
              color: #e0e0e0;
            }
          }
        </style>

        <!-- Confirmation Dialog for existing analysis -->
        <div id="analyzer-error-confirm-dialog" class="jenkins-hidden">
          <l:card title="AI Error Analysis Exists">
            <p>An AI analysis was already generated on <span id="existing-analysis-timestamp"></span>.</p>
            <p>Do you want to view the existing analysis or generate a new one?</p>
            <div class="jenkins-button-bar">
              <button type="button" class="jenkins-button jenkins-button--primary jenkins-!-margin-1 eep-view-existing-button" onclick="viewExistingAnalysis()">
                View Existing
              </button>
              <button type="button" class="jenkins-button jenkins-!-margin-1 eep-generate-new-button">
                Generate New
              </button>
              <button type="button" class="jenkins-button jenkins-!-margin-1 eep-cancel-button" onclick="cancelAnalysis()">
                Cancel
              </button>
            </div>
          </l:card>
        </div>
    </j:if>
</j:jelly>
